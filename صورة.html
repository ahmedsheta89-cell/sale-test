<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Zone - Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root{--p:#e74c3c;--pd:#c0392b;--g:#27ae60;--s:#2c3e50;--a:#f39c12;--info:#3498db;--bg:#f5f6fa;--card:#fff;--border:#e0e0e0;--hero:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--s)}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--p);border-radius:10px}

        .header{background:var(--hero);padding:20px 25px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
        .header h1{font-size:20px;display:flex;align-items:center;gap:8px}
        .header p{font-size:11px;color:#95a5a6}
        .header .stats{display:flex;gap:15px}
        .header .stat{text-align:center}
        .header .stat h3{font-size:18px;color:var(--a)}
        .header .stat small{font-size:9px;color:#95a5a6}

        .container{max-width:1400px;margin:20px auto;padding:0 20px}

        /* Steps */
        .steps{display:flex;gap:5px;margin-bottom:20px;background:var(--card);padding:10px;border-radius:12px;box-shadow:0 3px 15px rgba(0,0,0,0.05);flex-wrap:wrap}
        .step{flex:1;min-width:120px;padding:10px;border-radius:8px;text-align:center;font-size:11px;font-weight:700;transition:0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}
        .step.active{background:var(--p);color:white}
        .step.done{background:var(--g);color:white}
        .step i{font-size:14px}

        /* Cards */
        .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 3px 15px rgba(0,0,0,0.05);margin-bottom:15px}
        .card h3{font-size:15px;margin-bottom:12px;display:flex;align-items:center;gap:6px}

        /* Upload Zone */
        .upload-zone{border:3px dashed var(--border);border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:0.3s;background:var(--bg);position:relative}
        .upload-zone:hover,.upload-zone.over{border-color:var(--p);background:rgba(231,76,60,0.03)}
        .upload-zone i{font-size:40px;color:var(--p);margin-bottom:8px}
        .upload-zone h4{font-size:14px;margin-bottom:4px}
        .upload-zone span{font-size:10px;color:#95a5a6}
        .upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}

        .upload-info{display:none;margin-top:10px;padding:10px;background:#e8f8f5;border-radius:8px;color:var(--g);font-weight:700;font-size:11px;text-align:center}
        .upload-info.show{display:block}

        /* Thumbnails */
        .thumbs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px}
        .thumb-item{position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;background:var(--bg);border:2px solid var(--border)}
        .thumb-item img{width:100%;height:100%;object-fit:cover}
        .thumb-item .thumb-name{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);color:white;font-size:7px;padding:3px 5px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .thumb-item .thumb-remove{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:var(--p);color:white;border:none;font-size:8px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .thumb-item.matched{border-color:var(--g);border-width:3px}
        .thumb-item.unmatched{border-color:var(--a);border-width:3px}

        /* Matching Table */
        .match-table{width:100%;border-collapse:collapse;font-size:11px}
        .match-table th{background:var(--s);color:white;padding:8px 10px;text-align:right;white-space:nowrap;position:sticky;top:0;z-index:2}
        .match-table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
        .match-table tr:hover{background:#f8f9fa}
        .match-table .prod-img{width:50px;height:50px;border-radius:6px;overflow:hidden;background:var(--bg)}
        .match-table .prod-img img{width:100%;height:100%;object-fit:cover}
        .match-table .prod-img .no-img{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:18px}
        .match-table .match-status{padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;display:inline-flex;align-items:center;gap:3px}
        .match-table .match-status.matched{background:#e8f8f5;color:var(--g)}
        .match-table .match-status.unmatched{background:#fef3e2;color:var(--a)}
        .match-table .match-status.manual{background:#e3f2fd;color:var(--info)}
        .match-table select{padding:4px 6px;border:1.5px solid var(--border);border-radius:5px;font-family:'Cairo';font-size:9px;min-width:120px;background:var(--card)}
        .match-table select:focus{outline:none;border-color:var(--p)}
        .match-table .img-select-preview{width:40px;height:40px;border-radius:4px;overflow:hidden;cursor:pointer;border:2px solid var(--border)}
        .match-table .img-select-preview img{width:100%;height:100%;object-fit:cover}
        .match-table .img-select-preview:hover{border-color:var(--p)}
        .match-table .file-input-cell input{font-size:9px;width:100%;max-width:120px}
        .match-scroll{max-height:60vh;overflow-y:auto;border-radius:8px;border:1px solid var(--border)}

        /* Buttons */
        .btn{padding:8px 18px;border:none;border-radius:8px;font-family:'Cairo';font-size:12px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:0.3s}
        .btn:hover{transform:translateY(-1px)}
        .btn-p{background:var(--p);color:white}
        .btn-g{background:var(--g);color:white}
        .btn-b{background:var(--info);color:white}
        .btn-a{background:var(--a);color:var(--s)}
        .btn-gray{background:#95a5a6;color:white}
        .btn-lg{padding:12px 30px;font-size:14px}

        /* Progress */
        .progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin:10px 0}
        .progress-fill{height:100%;background:var(--g);border-radius:4px;transition:width 0.5s}

        .progress-text{text-align:center;font-size:12px;font-weight:700;color:var(--g)}

        /* Result Cards */
        .result-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px}
        .result-card{background:var(--card);border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.04);border:1px solid var(--border)}
        .result-card .r-img{height:140px;overflow:hidden;background:var(--bg);position:relative}
        .result-card .r-img img{width:100%;height:100%;object-fit:cover}
        .result-card .r-img .no-img{height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:30px}
        .result-card .r-body{padding:10px}
        .result-card .r-name{font-size:11px;font-weight:700;margin-bottom:3px}
        .result-card .r-code{font-size:9px;color:#95a5a6;margin-bottom:3px}
        .result-card .r-status{font-size:9px;font-weight:700}
        .result-card .r-status.ok{color:var(--g)}
        .result-card .r-status.no{color:var(--p)}

        /* Toast */
        .toast{position:fixed;bottom:15px;right:15px;padding:10px 20px;border-radius:8px;font-family:'Cairo';font-size:11px;font-weight:700;z-index:5000;display:flex;align-items:center;gap:5px;transform:translateY(50px);opacity:0;transition:0.4s;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.ok{background:var(--s);color:white;border-right:3px solid var(--g)}
        .toast.err{background:var(--s);color:white;border-right:3px solid var(--p)}

        /* ImgBB Upload Status */
        .upload-status{margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;font-size:10px}
        .upload-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)}
        .upload-row:last-child{border:none}
        .upload-row .status-icon{font-size:12px}

        .actions-bar{display:flex;gap:6px;margin:12px 0;flex-wrap:wrap;align-items:center}

        @media(max-width:768px){
            .header{flex-direction:column;text-align:center}
            .steps{flex-direction:column}
            .thumbs-grid{grid-template-columns:repeat(auto-fill,minmax(70px,1fr))}
            .result-grid{grid-template-columns:repeat(2,1fr)}
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div>
        <h1><i class="fas fa-images"></i> Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p>Ø§Ø±ÙØ¹ ØµÙˆØ± Ù…Ù†ØªØ¬Ø§ØªÙƒ ÙˆØ·Ø§Ø¨Ù‚Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
    </div>
    <div class="stats">
        <div class="stat"><h3 id="stProds">0</h3><small>Ù…Ù†ØªØ¬</small></div>
        <div class="stat"><h3 id="stImgs">0</h3><small>ØµÙˆØ±Ø©</small></div>
        <div class="stat"><h3 id="stMatched">0</h3><small>Ù…ØªØ·Ø§Ø¨Ù‚</small></div>
    </div>
</div>

<div class="container">

<!-- Steps -->
<div class="steps">
    <div class="step active" id="step1"><i class="fas fa-box"></i> 1. Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div class="step" id="step2"><i class="fas fa-upload"></i> 2. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±</div>
    <div class="step" id="step3"><i class="fas fa-link"></i> 3. Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
    <div class="step" id="step4"><i class="fas fa-cloud-upload-alt"></i> 4. Ø±ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
    <div class="step" id="step5"><i class="fas fa-check-circle"></i> 5. Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
</div>

<!-- Step 1: Load Products -->
<div class="card" id="panel1">
    <h3><i class="fas fa-box" style="color:var(--p)"></i> Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
    <p style="font-size:11px;color:#95a5a6;margin-bottom:12px">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡ØªØªØ­Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø¥ÙƒØ³Ù„</p>

    <div id="existingProds" style="display:none;margin-bottom:12px">
        <div style="padding:10px;background:#e8f8f5;border-radius:8px;color:var(--g);font-weight:700;font-size:12px;display:flex;align-items:center;gap:6px">
            <i class="fas fa-check-circle"></i>
            <span id="existingCount">0</span> Ù…Ù†ØªØ¬ Ù…Ø­Ù…Ù‘Ù„ Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø©
        </div>
        <button class="btn btn-g" onclick="useExisting()" style="margin-top:8px"><i class="fas fa-arrow-left"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</button>
    </div>

    <div class="upload-zone" id="excelZone">
        <i class="fas fa-file-excel"></i>
        <h4>Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø¥ÙƒØ³Ù„</h4>
        <span>ÙŠØ¯Ø¹Ù… .xlsx .xls .csv</span>
        <input type="file" accept=".xlsx,.xls,.csv" onchange="loadExcel(event)">
    </div>
    <div class="upload-info" id="excelInfo"></div>
</div>

<!-- Step 2: Upload Images -->
<div class="card" id="panel2" style="display:none">
    <h3><i class="fas fa-upload" style="color:var(--info)"></i> Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</h3>
    <p style="font-size:11px;color:#95a5a6;margin-bottom:12px">
        Ø§Ø±ÙØ¹ ÙƒÙ„ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©. Ø³Ù…Ù‘ÙŠ Ø§Ù„ØµÙˆØ± Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø£ÙØ¶Ù„.
    </p>

    <div class="upload-zone" id="imgZone">
        <i class="fas fa-images"></i>
        <h4>Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</h4>
        <span>ÙŠØ¯Ø¹Ù… JPG, PNG, WEBP - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© ØµÙˆØ±</span>
        <input type="file" accept="image/*" multiple onchange="loadImages(event)">
    </div>

    <div class="upload-info" id="imgInfo"></div>

    <div id="thumbsContainer" style="display:none">
        <h4 style="margin:12px 0 8px;font-size:13px"><i class="fas fa-images" style="color:var(--info)"></i> Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© (<span id="imgCount">0</span>)</h4>
        <div class="thumbs-grid" id="thumbsGrid"></div>
        <div class="actions-bar">
            <button class="btn btn-p" onclick="goToStep(3)"><i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
            <button class="btn btn-gray" onclick="clearImages()"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
    </div>
</div>

<!-- Step 3: Matching -->
<div class="card" id="panel3" style="display:none">
    <h3><i class="fas fa-link" style="color:var(--g)"></i> Ø§Ù„Ø®Ø·ÙˆØ© 3: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>

    <div class="progress-bar"><div class="progress-fill" id="matchProgress"></div></div>
    <div class="progress-text" id="matchText">0 Ù…Ù† 0 Ù…ØªØ·Ø§Ø¨Ù‚</div>

    <p style="font-size:10px;color:#95a5a6;margin:8px 0">
        âœ… Ø§Ù„Ø£Ø®Ø¶Ø± = ØªÙ… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ &nbsp;&nbsp; ğŸŸ¡ Ø§Ù„Ø£ØµÙØ± = Ù…Ø­ØªØ§Ø¬ ØªØ®ØªØ§Ø± ÙŠØ¯ÙˆÙŠ &nbsp;&nbsp; ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø£ÙŠ Ù…Ù†ØªØ¬
    </p>

    <div class="actions-bar">
        <button class="btn btn-g" onclick="autoMatch()"><i class="fas fa-magic"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</button>
        <button class="btn btn-b" onclick="clearAllMatches()"><i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
    </div>

    <div class="match-scroll">
        <table class="match-table">
            <thead><tr>
                <th>#</th><th>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ø®ØªØ§Ø± ØµÙˆØ±Ø©</th><th>Ø£Ùˆ Ø§Ø±ÙØ¹</th>
            </tr></thead>
            <tbody id="matchBody"></tbody>
        </table>
    </div>

    <div class="actions-bar" style="margin-top:12px">
        <button class="btn btn-p btn-lg" onclick="goToStep(4)"><i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ: Ø±ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
        <button class="btn btn-a" onclick="saveLocally()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·</button>
    </div>
</div>

<!-- Step 4: Upload Online -->
<div class="card" id="panel4" style="display:none">
    <h3><i class="fas fa-cloud-upload-alt" style="color:var(--a)"></i> Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (ImgBB)</h3>
    <p style="font-size:11px;color:#95a5a6;margin-bottom:12px">
        Ù‡Ù†Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¹Ù„Ù‰ ImgBB Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙˆØªØ§Ø®Ø¯ Ø±ÙˆØ§Ø¨Ø· Ø¯Ø§Ø¦Ù…Ø©. Ø£Ùˆ Ù…Ù…ÙƒÙ† ØªØªØ®Ø·Ù‰ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ± Ù…Ø­Ù„ÙŠØ§Ù‹.
    </p>

    <div style="padding:12px;background:#fff3cd;border-radius:8px;font-size:11px;margin-bottom:12px;line-height:1.8">
        <b>ğŸ“Œ Ù„Ù„Ø±ÙØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:</b><br>
        1. Ø§ÙØªØ­ <a href="https://api.imgbb.com/" target="_blank" style="color:var(--info)">https://api.imgbb.com</a><br>
        2. Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨ Ù…Ø¬Ø§Ù†ÙŠ<br>
        3. Ø§Ù†Ø³Ø® Ø§Ù„Ù€ API Key<br>
        4. Ø§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§ ØªØ­Øª ğŸ‘‡
    </div>

    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;align-items:flex-end">
        <div style="flex:1;min-width:200px">
            <label style="font-size:10px;font-weight:700;display:block;margin-bottom:3px">ImgBB API Key</label>
            <input type="text" id="imgbbKey" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù€ API Key Ù‡Ù†Ø§" style="width:100%;padding:8px;border:2px solid var(--border);border-radius:6px;font-family:'Cairo';font-size:11px">
        </div>
        <button class="btn btn-g" onclick="uploadToImgBB()"><i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ø§Ù„ÙƒÙ„ Ø¹Ù„Ù‰ ImgBB</button>
    </div>

    <div id="uploadProgress" style="display:none">
        <div class="progress-bar"><div class="progress-fill" id="uploadProgressBar"></div></div>
        <div class="progress-text" id="uploadProgressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</div>
        <div class="upload-status" id="uploadStatusList"></div>
    </div>

    <div class="actions-bar" style="margin-top:12px">
        <button class="btn btn-a" onclick="goToStep(5)"><i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button class="btn btn-gray" onclick="skipUpload()"><i class="fas fa-forward"></i> ØªØ®Ø·ÙŠ (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­Ù„ÙŠ)</button>
    </div>
</div>

<!-- Step 5: Result -->
<div class="card" id="panel5" style="display:none">
    <h3><i class="fas fa-check-circle" style="color:var(--g)"></i> Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>

    <div class="progress-bar"><div class="progress-fill" id="resultProgress"></div></div>
    <div class="progress-text" id="resultText"></div>

    <div class="result-grid" id="resultGrid"></div>

    <div class="actions-bar" style="margin-top:15px">
        <button class="btn btn-g btn-lg" onclick="applyToStore()"><i class="fas fa-check"></i> ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn btn-b" onclick="exportWithImages()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ø¨Ø§Ù„ØµÙˆØ±</button>
        <button class="btn btn-a" onclick="copyImageLinks()"><i class="fas fa-copy"></i> Ù†Ø³Ø® ÙƒÙ„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ±</button>
    </div>
</div>

</div><!-- container -->

<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let products = [];
let uploadedImages = []; // {name, file, dataUrl, matchedTo, onlineUrl}
let imgbbKey = '';

// Load existing products from main store
const saved = localStorage.getItem('sz_products');
if(saved){
    try{
        products = JSON.parse(saved);
        if(products.length){
            document.getElementById('existingProds').style.display='block';
            document.getElementById('existingCount').textContent=products.length;
        }
    }catch(e){}
}
updateStats();

// ===== STEP NAVIGATION =====
function goToStep(n){
    for(let i=1;i<=5;i++){
        document.getElementById('panel'+i).style.display=i===n?'block':'none';
        const step=document.getElementById('step'+i);
        step.classList.remove('active','done');
        if(i<n)step.classList.add('done');
        if(i===n)step.classList.add('active');
    }
    window.scrollTo({top:0,behavior:'smooth'});
    if(n===3)renderMatchTable();
    if(n===5)renderResults();
}

// ===== STEP 1: LOAD PRODUCTS =====
function useExisting(){
    toast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} Ù…Ù†ØªØ¬ âœ…`,'ok');
    updateStats();
    goToStep(2);
}

function loadExcel(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
        try{
            let json;
            if(file.name.endsWith('.csv')){
                json=ev.target.result.split('\n').map(r=>r.split(',').map(c=>c.trim().replace(/^"|"$/g,'')));
            }else{
                const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
                json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
            }
            const rows=json.filter(r=>r.some(c=>String(c||'').trim()));
            if(rows.length<2){toast('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº','err');return}
            // Simple parse: assume first row is header
            const headers=rows[0].map(h=>String(h||'').trim().toLowerCase());
            const nameIdx=headers.findIndex(h=>['Ø§Ø³Ù…','name','Ø§Ù„Ù…Ù†ØªØ¬','product','Ø¨ÙŠØ§Ù†','ØµÙ†Ù','Ù…Ù†ØªØ¬'].some(k=>h.includes(k)));
            const codeIdx=headers.findIndex(h=>['ÙƒÙˆØ¯','code','Ø¨Ø§Ø±ÙƒÙˆØ¯','barcode'].some(k=>h.includes(k)));
            const priceIdx=headers.findIndex(h=>['Ø³Ø¹Ø±','price','Ø¨ÙŠØ¹','sell','Ø¬Ù…Ù„Ù‡','Ø¨Ø¹Ø¯'].some(k=>h.includes(k)));

            if(nameIdx===-1){toast('Ù…Ø´ Ù„Ø§Ù‚ÙŠ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…','err');return}

            products=rows.slice(1).map((r,i)=>{
                const name=String(r[nameIdx]||'').trim();
                if(!name)return null;
                return{
                    id:i+1,name,
                    code:codeIdx>=0?String(r[codeIdx]||'').trim():'',
                    newPrice:priceIdx>=0?(parseFloat(r[priceIdx])||0):0,
                    oldPrice:0,description:'',image:'',category:'Ø¹Ø§Ù…',stock:-1
                };
            }).filter(Boolean);

            document.getElementById('excelInfo').classList.add('show');
            document.getElementById('excelInfo').textContent=`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} Ù…Ù†ØªØ¬`;
            updateStats();
            setTimeout(()=>goToStep(2),500);
        }catch(err){toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù','err');console.error(err)}
    };
    if(file.name.endsWith('.csv'))reader.readAsText(file);
    else reader.readAsArrayBuffer(file);
}

// ===== STEP 2: UPLOAD IMAGES =====
const imgZone=document.getElementById('imgZone');
imgZone.addEventListener('dragover',e=>{e.preventDefault();imgZone.classList.add('over')});
imgZone.addEventListener('dragleave',()=>imgZone.classList.remove('over'));
imgZone.addEventListener('drop',e=>{e.preventDefault();imgZone.classList.remove('over');handleImageFiles(e.dataTransfer.files)});

function loadImages(e){handleImageFiles(e.target.files)}

function handleImageFiles(files){
    if(!files.length)return;
    let loaded=0;
    Array.from(files).forEach(file=>{
        if(!file.type.startsWith('image/'))return;
        const reader=new FileReader();
        reader.onload=ev=>{
            uploadedImages.push({
                name:file.name,
                cleanName:file.name.replace(/\.[^.]+$/,'').toLowerCase().trim(),
                file:file,
                dataUrl:ev.target.result,
                matchedTo:null,
                onlineUrl:''
            });
            loaded++;
            if(loaded>=files.length||loaded>=Array.from(files).filter(f=>f.type.startsWith('image/')).length){
                renderThumbs();
                document.getElementById('imgInfo').classList.add('show');
                document.getElementById('imgInfo').textContent=`âœ… ØªÙ… Ø±ÙØ¹ ${uploadedImages.length} ØµÙˆØ±Ø©`;
                updateStats();
                autoMatch();
            }
        };
        reader.readAsDataURL(file);
    });
}

function renderThumbs(){
    const container=document.getElementById('thumbsContainer');
    const grid=document.getElementById('thumbsGrid');
    container.style.display='block';
    document.getElementById('imgCount').textContent=uploadedImages.length;

    grid.innerHTML=uploadedImages.map((img,i)=>`
        <div class="thumb-item ${img.matchedTo!==null?'matched':'unmatched'}">
            <img src="${img.dataUrl}" alt="${img.name}">
            <div class="thumb-name">${img.name}</div>
            <button class="thumb-remove" onclick="removeImage(${i})"><i class="fas fa-times"></i></button>
        </div>
    `).join('');
}

function removeImage(idx){
    uploadedImages.splice(idx,1);
    renderThumbs();updateStats();
}

function clearImages(){
    uploadedImages=[];
    document.getElementById('thumbsContainer').style.display='none';
    document.getElementById('imgInfo').classList.remove('show');
    updateStats();
}

// ===== AUTO MATCHING =====
function autoMatch(){
    let matched=0;
    // Reset all matches
    uploadedImages.forEach(img=>img.matchedTo=null);

    products.forEach(prod=>{
        const prodName=prod.name.toLowerCase().trim();
        const prodCode=(prod.code||'').toLowerCase().trim();

        let bestMatch=null, bestScore=0;

        uploadedImages.forEach((img,imgIdx)=>{
            if(img.matchedTo!==null)return;
            const imgName=img.cleanName;
            let score=0;

            // Exact match with code
            if(prodCode&&imgName===prodCode)score=100;
            // Exact match with name
            else if(imgName===prodName)score=95;
            // Code contained in image name
            else if(prodCode&&imgName.includes(prodCode))score=80;
            // Image name contained in product name
            else if(prodName.includes(imgName))score=70;
            // Product name contained in image name
            else if(imgName.includes(prodName))score=70;
            // Partial match - words
            else{
                const prodWords=prodName.split(/[\s\-\_\.]+/).filter(w=>w.length>2);
                const imgWords=imgName.split(/[\s\-\_\.]+/).filter(w=>w.length>2);
                const commonWords=prodWords.filter(w=>imgWords.some(iw=>iw.includes(w)||w.includes(iw)));
                if(commonWords.length>0)score=30+(commonWords.length/Math.max(prodWords.length,1))*40;
            }

            if(score>bestScore){bestScore=score;bestMatch=imgIdx}
        });

        if(bestMatch!==null&&bestScore>=30){
            uploadedImages[bestMatch].matchedTo=prod.id;
            prod.image=uploadedImages[bestMatch].dataUrl;
            matched++;
        }
    });

    updateStats();
    renderThumbs();
    toast(`ØªÙ… Ù…Ø·Ø§Ø¨Ù‚Ø© ${matched} ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ âœ…`,'ok');
    return matched;
}

// ===== STEP 3: MATCHING TABLE =====
function renderMatchTable(){
    const body=document.getElementById('matchBody');
    const matchedCount=products.filter(p=>p.image).length;
    const total=products.length;

    document.getElementById('matchProgress').style.width=(matchedCount/total*100)+'%';
    document.getElementById('matchText').textContent=`${matchedCount} Ù…Ù† ${total} Ù…ØªØ·Ø§Ø¨Ù‚ (${Math.round(matchedCount/total*100)}%)`;

    body.innerHTML=products.map((p,i)=>{
        const matchedImg=uploadedImages.find(img=>img.matchedTo===p.id);
        const hasImage=!!p.image;
        const statusClass=hasImage?(matchedImg?'matched':'manual'):'unmatched';
        const statusText=hasImage?(matchedImg?'âœ… ØªÙ„Ù‚Ø§Ø¦ÙŠ':'ğŸ”µ ÙŠØ¯ÙˆÙŠ'):'ğŸŸ¡ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©';

        return`<tr>
            <td>${i+1}</td>
            <td><div class="prod-img">${p.image?`<img src="${p.image}">`:'<div class="no-img"><i class="fas fa-image"></i></div>'}</div></td>
            <td style="font-weight:700;font-size:10px">${p.name}</td>
            <td style="font-size:9px;color:#95a5a6">${p.code||'-'}</td>
            <td>${matchedImg?`<div class="img-select-preview"><img src="${matchedImg.dataUrl}"></div>`:'â€”'}</td>
            <td><span class="match-status ${statusClass}">${statusText}</span></td>
            <td>
                <select onchange="manualMatch(${p.id},this.value)">
                    <option value="">Ø§Ø®ØªØ§Ø± ØµÙˆØ±Ø©...</option>
                    ${uploadedImages.map((img,idx)=>`<option value="${idx}" ${img.matchedTo===p.id?'selected':''}>${img.name}</option>`).join('')}
                </select>
            </td>
            <td class="file-input-cell">
                <input type="file" accept="image/*" onchange="uploadSingleImage(${p.id},this)">
            </td>
        </tr>`;
    }).join('');
}

function manualMatch(prodId,imgIdx){
    // Clear previous match for this product
    uploadedImages.forEach(img=>{if(img.matchedTo===prodId)img.matchedTo=null});

    if(imgIdx!==''){
        const idx=parseInt(imgIdx);
        // Clear previous match for this image
        if(uploadedImages[idx].matchedTo!==null){
            const prevProd=products.find(p=>p.id===uploadedImages[idx].matchedTo);
            if(prevProd)prevProd.image='';
        }
        uploadedImages[idx].matchedTo=prodId;
        const prod=products.find(p=>p.id===prodId);
        if(prod)prod.image=uploadedImages[idx].dataUrl;
    }else{
        const prod=products.find(p=>p.id===prodId);
        if(prod)prod.image='';
    }
    renderMatchTable();updateStats();
}

function uploadSingleImage(prodId,input){
    const file=input.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=e=>{
        const prod=products.find(p=>p.id===prodId);
        if(prod){
            prod.image=e.target.result;
            uploadedImages.push({name:file.name,cleanName:file.name.replace(/\.[^.]+$/,''),file,dataUrl:e.target.result,matchedTo:prodId,onlineUrl:''});
        }
        renderMatchTable();updateStats();toast('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© âœ…','ok');
    };
    reader.readAsDataURL(file);
}

function clearAllMatches(){
    uploadedImages.forEach(img=>img.matchedTo=null);
    products.forEach(p=>p.image='');
    renderMatchTable();updateStats();
}

function saveLocally(){
    localStorage.setItem('sz_products',JSON.stringify(products));
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ âœ…','ok');
    goToStep(5);
}

// ===== STEP 4: UPLOAD TO IMGBB =====
async function uploadToImgBB(){
    imgbbKey=document.getElementById('imgbbKey').value.trim();
    if(!imgbbKey){toast('Ø§Ø¯Ø®Ù„ API Key Ø£ÙˆÙ„Ø§Ù‹','err');return}

    const toUpload=uploadedImages.filter(img=>img.matchedTo!==null&&!img.onlineUrl);
    if(!toUpload.length){toast('Ù…ÙÙŠØ´ ØµÙˆØ± Ù…Ø­ØªØ§Ø¬Ø© Ø±ÙØ¹','err');return}

    document.getElementById('uploadProgress').style.display='block';
    const statusList=document.getElementById('uploadStatusList');
    statusList.innerHTML='';

    let uploaded=0,failed=0;

    for(const img of toUpload){
        try{
            const formData=new FormData();
            formData.append('image',img.dataUrl.split(',')[1]);
            formData.append('key',imgbbKey);
            formData.append('name',img.cleanName);

            const response=await fetch('https://api.imgbb.com/1/upload',{method:'POST',body:formData});
            const data=await response.json();

            if(data.success){
                img.onlineUrl=data.data.url;
                const prod=products.find(p=>p.id===img.matchedTo);
                if(prod)prod.image=data.data.url;
                uploaded++;
                statusList.innerHTML+=`<div class="upload-row"><span>âœ… ${img.name}</span><span style="font-size:8px;color:var(--g)">${data.data.url.substring(0,40)}...</span></div>`;
            }else{
                failed++;
                statusList.innerHTML+=`<div class="upload-row"><span>âŒ ${img.name}</span><span style="color:var(--p);font-size:9px">${data.error?.message||'Ø®Ø·Ø£'}</span></div>`;
            }
        }catch(err){
            failed++;
            statusList.innerHTML+=`<div class="upload-row"><span>âŒ ${img.name}</span><span style="color:var(--p);font-size:9px">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</span></div>`;
        }

        const total=toUpload.length;
        const done=uploaded+failed;
        document.getElementById('uploadProgressBar').style.width=(done/total*100)+'%';
        document.getElementById('uploadProgressText').textContent=`${done}/${total} â€” Ù†Ø¬Ø­: ${uploaded} | ÙØ´Ù„: ${failed}`;
    }

    // Save products with online URLs
    localStorage.setItem('sz_products',JSON.stringify(products));
    toast(`ØªÙ… Ø±ÙØ¹ ${uploaded} ØµÙˆØ±Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸ‰`,'ok');
}

function skipUpload(){
    // Save with local images (base64)
    localStorage.setItem('sz_products',JSON.stringify(products));
    goToStep(5);
}

// ===== STEP 5: RESULTS =====
function renderResults(){
    const withImg=products.filter(p=>p.image);
    const withOnline=products.filter(p=>p.image&&p.image.startsWith('http'));
    const total=products.length;

    document.getElementById('resultProgress').style.width=(withImg.length/total*100)+'%';
    document.getElementById('resultText').textContent=`${withImg.length}/${total} Ù…Ù†ØªØ¬ Ø¨ØµÙˆØ±Ø© (${withOnline.length} Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†)`;

    document.getElementById('resultGrid').innerHTML=products.map(p=>`
        <div class="result-card">
            <div class="r-img">${p.image?`<img src="${p.image}">`:'<div class="no-img"><i class="fas fa-image"></i></div>'}</div>
            <div class="r-body">
                <div class="r-name">${p.name}</div>
                ${p.code?`<div class="r-code"><i class="fas fa-barcode"></i> ${p.code}</div>`:''}
                <div class="r-status ${p.image?'ok':'no'}">${p.image?(p.image.startsWith('http')?'âœ… Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†':'ğŸ“ Ù…Ø­Ù„ÙŠ'):'âŒ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©'}</div>
            </div>
        </div>
    `).join('');
}

function applyToStore(){
    localStorage.setItem('sz_products',JSON.stringify(products));
    toast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø© âœ… - Ø§ÙØªØ­ Ø§Ù„Ù…Ø¬Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©','ok');
}

function exportWithImages(){
    const data=[['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„ÙƒÙˆØ¯','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„ØµÙˆØ±Ø©','Ø§Ù„ØªØµÙ†ÙŠÙ']];
    products.forEach(p=>data.push([p.name,p.code,p.newPrice,p.image||'',p.category]));
    const ws=XLSX.utils.aoa_to_sheet(data),wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Products');
    XLSX.writeFile(wb,'SaleZone_WithImages.xlsx');
    toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ…','ok');
}

function copyImageLinks(){
    const links=products.filter(p=>p.image).map(p=>`${p.name}: ${p.image}`).join('\n');
    navigator.clipboard.writeText(links).then(()=>toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±ÙˆØ§Ø¨Ø· âœ…','ok'));
}

// ===== UTILS =====
function updateStats(){
    document.getElementById('stProds').textContent=products.length;
    document.getElementById('stImgs').textContent=uploadedImages.length;
    document.getElementById('stMatched').textContent=products.filter(p=>p.image).length;
}

function toast(msg,type){
    const t=document.getElementById('toast');
    t.className=`toast ${type}`;t.innerHTML=`<i class="fas ${type==='ok'?'fa-check-circle':'fa-exclamation-circle'}"></i> ${msg}`;
    t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>